---
title: 网络基础
createTime: 2025/03/29 17:03:01
permalink: /article/cr34dfbh/
---
# 1.概述

## 1、网络的网络

> **网络**「由若干节点和连接这些节点的链路组成」把主机连接起来，而**互联网**(`internet`)是把多种不同的网络连接起来，因此互联网是网络的网络。而**因联网**(`Internet`)是全球范围的互联网。

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209691.jpeg)

## 2、ISP
互联网服务提供商`ISP`可以从互联网管理机构获得许多`IP`地址，同时拥有通信线路以及路由器等联网设备，个人或机构向`ISP`缴纳一定的费用就可以接入互联网。

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209692.png)

目前的互联网是一种多层次`ISP`结构，`ISP`根据覆盖面积的大小分为第一层`ISP`、区域`ISP`和接入`ISP`。互联网交换点`IXP`允许两个`ISP`直接相连而不用经过第三个`ISP`「减少延迟」。

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209693.png)

![image-20250304143247094](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209694.png)

## 3、三种交换方式
### （1）电路交换

电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的网络链路，并且在整个通信过程中始终占用该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209695.png)

### （2）分组交换

每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路是同时传输多个分组互相不会影响，因此在同一条线路是允许同时传输多个分组，也就是说分组交换不需要占用传输线路。

在一个邮局通信系统中，邮局收到一封邮件后，先存储下来，然后把相同目的地的邮件一起转发到下一个目的地，这个过程就是存储转发过程，分组交换也使用了存储转发过程。

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209697.png)

### （3）报文交换

报文交换中的交换节点也采用存储转发方式，但报文交换对报文的大小没有限制，这就要求交换节点需要较大的存储空间。报文交换主要用于早起的电报通信网，现在较少使用，通常被较先进的分组交换方式所取代。

### （4）对比

假设 A、B、C、D 是分组传输路径所要经过的 4 个结点交换机，纵坐标为时间

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209698.png)

## 4、计算机网络的定义和分类

定义：

+ 一些互相连接的，自治「独立，有自己的硬件和软件」的计算机的集合。
+ 主要是有一些通用的、可编程的硬件互连而成的，而这些硬件并非专门用来实现某一目的的。这些可编程的硬件能够用来传送多种不同类型的数据，并能支持广泛和日益增长的应用。

![image-20250304144927669](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209699.png)

## 5、计算机网络的性能指标

+ 速率：连接在计算机网络上的主机在数字信道上传送比特的速率，也称为比特率或数据率「b/s，bps」。
+ 带宽：网络的通信线路所能传送数据的能力，表示在单位时间内从网络中的某一点到另一点所能通过的“最后数据率”「b/s」。
+ 吞吐量：单位时间内通用某个网络的数据量。
+ 时延：总时延 = 处理时延「忽略」 + 传播时延「信道长度/电磁波传播速率」 + 发送时延「分组长度/发送速率」。当处理时延忽略不计时，发送时延和传播时延谁占主导，要具体情况具体分析。
+ 时延带宽积：传播时延*带宽「链路的时延带宽积：以比特为单位的链路长度」。
+ 往返时间（RTT）：双向交互一次所需要的时间。
+ 利用率：「信道利用率」某信道有百分之几的时间是被利用的，「网络利用率」全网络的信道利用率的加权平均。
+ 丢包率：在一定的时间范围内，传输过程中丢失的分组数量与总分组数量的比率。

## 6、计算机网络体系结构
![image-20250304151353656](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209700.png)

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209701.png)

### （1）五层协议
- [x] 应用层：解决通过应用进程的交互来实现特定网络应用的问题。
- [x] 运输层：解决进程之间基于网络的通信问题。
- [x] 网络层：解决分组在多个网络之间传输的问题。
- [x] 数据链路层：解决分组在一个网络上传输的问题。
- [x] 物理层：解决使用何种信号来传输比特0和1的问题。「物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。」

### （2）OSI
- [x] 表示层：解决通信双方交换信息的表示问题。
- [x] 会话层：解决进程之间进行会话的问题。

五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理。

### （3）TCP/IP
只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。TCP/IP体系结构不严格遵循OSI分层概念，应用层可能会直接使用IP或者网络接口层。

![](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209702.png)

### （4）数据在各层之间的传递过程
在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。

路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要传输层和网络层。

### （5）计算机网络体系结构的专用术语
+ 实体：任何可发送或接收信息的硬件或软件进程。「对等实体」收发双方相同层次中的实体。「看得见下层所提供的服务，不知道该服务的具体协议」。
+ 协议：控制两个对等实体进行逻辑通信的规则的集合。「语法/格式、语意/动作、同步/时序」。「水平的」
+ 服务：在协议的控制下，两个对等实体间的逻辑通信使得本层能够向上一层提供服务「垂直的」
+ 服务访问点：在同一系统中相邻两层的实体交换信息的逻辑接口，用于区分不同的服务类型。
+ 服务原语：上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令称为服务原语。
+ 协议数据单元PDU：对等层次之间传送的数据包称为该层的协议数据单元。
+ 服务数据单元SDU：同一系统内，层与层交换的数据包称为服务数据单元。

# 2.物理层

## 1、传输方式

+ 串行传输：数据是一个比特一个比特依次发送的，因此在发送端与接收端之间，只需要一条数据传输线路即可
+ 并行传输
	+ 一次发送n个比特，因此，在发送端和接收端之间需要有n条传输线路
	+ 并行传输的优点是比串行传输的速度n倍，但成本高
	+ 数据在传输线路上的传输采用是串行传输，计算机内部的数据传输常用并行传输

+ 同步传输
	+ 数据块以稳定的比特流的形式传输。字节之间没有间隔
	+ 接收端在每个比特信号的中间时刻进行检测，以判别接收到的是比特0还是比特1
	+ 由于不同设备的时钟频率存在一定差异，不可能做到完全相同，在传输大量数据的过程中，所产生的判别时刻的累计误差，会导致接收端对比特信号的判别错位
	+ 所以要使收发双发时钟保持同步

+ 异步传输
	+ 以字节为独立的传输单位，字节之间的时间间隔不是固定
	+ 接收端仅在每个字节的起始处对字节内的比特实现同步
	+ 通常在每个字节前后分别加上起始位和结束位

+ 单工通信：单向传输
+ 半双工通信：双向交替传输「不能同时」
+ 全双工通信：双向同时传输

## 2、编码与调制

![image-20250304164741840](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209703.png)

+ 传输媒体不能直接与信道划等号「单/半双/全双」。

+ 常用编码：不归零编码、归零编码、曼彻斯特编码、差分曼彻斯特编码
+ 基本调制方法：调幅「AM」、调频「FM」、调相「PM」

## 3、信道极限容量

+ 任何实际的信道都不是理想的，在传输信号时会餐食各种失真以及多来多种干扰「失真因素：码元传输速率、信道传输距离、噪声干扰、传输媒体质量」。
+ 奈氏准则：在假定的理想条件在，为了避免码间串扰，码元传输速率是有上限的。
+ 香农公式：带宽受限且有高斯白噪声干扰的信道的极限信息传输速率。

# 3.数据链路层

## 1、三个重要问题「点对点信道」

### （1）封装成帧

+ 封装成帧是指数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧「帧头和帧尾中包含重要的控制信息，作用之一就是帧定界」。
+ 透明传输是指数据链路层对上层交付的传输数据没有任何限制，就好像数据链路层不存在一样。
	+ 面向字节的物理链路使用字节填充的方法实现透明传输
	+ 面向比特的物理链路使用比特填充的方法实现透明传输
	+ ![image-20250306084912764](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209704.png)
+ 为了提高帧的传输效率，应当使帧的数据部分的长度尽能大些「Max：最大传送单元MTU/差错控制...」

### （2）差错检测

+ 检错码只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此无法纠正错误。
+ 要想纠正传输中的差错，可以使用冗余信息更多的纠错码进行前向纠错，但纠错码的开销比价大，在计算机网络中较少使用。
+ 循环冗余校验CRC有很好的检错能力「漏检率非常低」，易于用硬件实现，因此被广泛应用于数据链路层。

### （3）可靠传输

<u>发送端发送什么，接收端就收到什么</u>，可靠传输的实现机制：

+ 停止-等待协议SW：发送方每发送一个数据帧后，等待接收方的确认（ACK）才能发送下一帧「如果超时未收到ACK，发送方重传该帧」
+ 回退N帧协议GBN：发送方可以连续发送多个数据帧，无需等待单个数据帧，接收方只按顺序确认，若某帧出错，丢弃该帧及后续所有帧，发送方需从出错帧开始重传。
+ 选择性重传协议SR：发送发可以连续发送多个数据帧，接受方对每个帧单独确认，若某帧出错，发送方只需重传出错的帧，其余帧无需重传。

## 2、PPP协议

PPP协议为在点对点链路传输各种协议数据报提供了一个标准方法，主要有：对各种协议数据报的封装方法「封装成帧」、链路控制协议LCP「用于建立、配置以及测试数据链路的链接」、一套网络控制协议NCPs「其中的每一个协议支持不同的网络层协议」

![image-20250310205236491](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209705.png)

PPP的帧格式：

![image-20250310205813760](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209706.png)

+ F字段为帧定界符「0x7E」
+ A「0xFF」和C「0x03」字段为预留字段
+ P字段是协议字段
+ FCS字段是使用CRC的检验序列

## 3、媒体接入控制MAC

### （1）静态划分信道

+ 频分复用FDM：频分复用的所有用户同时占用不用的频带资源进行通信。
+ 时分复用TDM：时分复用的所有用户在不同的时间占用同样的频带宽度。
+ 波分复用WDM：光的频分复用。
+ 码分复用CDM：每个用户分配一个独特的码片序列（通常是正交的伪随机码），发送方将数据与码片序列相乘后发送，接收方用相同的码片序列解码，提取特定用户的数据。
+ ![image-20250310213139036](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209707.png)

### （2）动态接入控制

+ CSMA/CD「载波监听多址接入/碰撞检测-总线局域网」
  + MA「多址接入」：多个站连接在一条总线上，竞争使用总线
  + CS「载波监听」：每一个站在发送帧之前先要检测一下总线上是否有其他站点在发送帧（先听后说）
  + CD「碰撞检测」：每一个正在发送帧的站边发送边检测碰撞（边说边听）
  + 争用期「碰撞窗口」：主机最多经过2τ「τ：端到端传播时延」的时长就可检测到本次发送是否遭受了碰撞，经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞
  + 截断二进制指数退避算法：当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用截断二进制指数退避算法来确定。
  	+ ![image-20250312181223688](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209708.png)
+ CSMA/CA「载波监听多址接入/碰撞避免-无线局域网」-802.11
  + 退避算法：当要发送帧的站点检测到新道从忙状态转为空闲时，都要执行退避算法。
  + 所有的站在完成发送后，必须等待一段帧间间隔时间才能发送下一帧「帧间间隔的长短取决于该站要发送的帧的优先级」
  + 无线局域网的MAC帧首部中有一个持续期字段，用来填入帧本帧结束后还要占用信道多久时间，其他站点通过该字段可实现虚拟载波监听。
  + 允许要发送数据的站点对信道进行预约，即在发送数据帧之前先发送请求发送RTS帧，在收到响应允许发送CTS帧后，就可发送数据帧。

## 4、MAC地址

MAC地址是数据链路层地址，长度为6字节「48位」，唯一标识网络上各个接口，例如网卡，交换机和路由器有更多的网络接口，所以拥有更多的MAC地址。

## 5、集线器与交换机

**以太网帧格式：**

+ 类型：标记上层使用的协议
+ 数据：长度在46-1500之间，如果太小则需要填充。
+ FCS：帧检验序列「CRC」

![image-20250312203108382](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209709.png)

![image-20250312202903283](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209710.png)

交换机具有**自学习能力**，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射。

正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有 4 个接口，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的映射写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送广播帧，主机 C 和主机 D 会丢弃该帧，主机 B 回应该帧向主机 A 发送数据包时，交换机查找交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机添加主机 B 到接口 2 的映射。

![image-20250312203406620](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209711.png)

每条记录都有自己的有效时间，到期自动删除！因为MAC地址与交换机接口的对应关系并不是永久性的「换网卡，换电脑...」

**以太网交换机的生成树协议STP：**

![image-20250312204036767](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209712.png)

## 6、虚拟局域网

虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。

例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

使用 VLAN 干线连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连 VLAN 交换机。IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了 4 字节首部 VLAN 标签，用于表示该帧属于哪一个虚拟局域网。

![image-20250312204259489](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209713.png)

# 4.网络层

## 1、概述

+ 网络层的主要任务是实现网络互连，进而实现数据包在各网络之间的传输
+ 要实现网络层任务，需要解决以下主要问题：
	+ 网络层向运输层提供怎样的服务「可靠传输 or 不可靠传输」
	+ 网络层寻址问题
	+ 路由选择问题
+ 与 IP 协议配套使用的还有三个协议：
	+ 地址解析协议 ARP（Address Resolution Protocol）
	+ 网际控制报文协议 ICMP（Internet Control Message Protocol）
	+ 网际组管理协议 IGMP（Internet Group Management Protocol）

![image-20250312205615264](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209714.png)

## 2、IP地址编址方式

![image-20250312211500493](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209715.png)

### （1）分类

`IP 地址 ::= {< 网络号 >, < 主机号 >}`

![image-20250312211742799](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209716.png)

### （2）划分子网

`IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}`，IPv4地址与其相应的子网掩码进行逻辑与「有0则0」运算就可以得到IPv4地址所在子网的网络地址

### （3）无分类

无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

`IP 地址 ::= {< 网络前缀号 >, < 主机号 >}`

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为 **构成超网** 。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用**最长前缀匹配**来确定应该匹配哪一个。

### （4）IP数据报的发送和转发过程

+ 主机发送IP数据报：判断主机是否与主机在同一个网络，同一网络->直接交付，不在同一网络->间接交付「默认网关帮忙转发」
+ 路由器转发IP数据报：
	+ 检查IP数据报首部是否出错，出错->丢弃并通告源主机，未出错->转发
	+ 根据IP数据报的目的地址在路由表中查找匹配的条目，找到->转发，找不到->丢弃并通告源主机

## 3、地址解析协议ARP

网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变。

![image-20250312213903110](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209717.png)

ARP 实现由 IP 地址得到 MAC 地址。

![image-20250312213920240](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209718.png)

每个主机都有一个 ARP 高速缓存，里面有本局域网上的各主机和路由器的 IP 地址到 MAC 地址的映射表。

如果主机 A 知道主机 B 的 IP 地址，但是 ARP 高速缓存中没有该 IP 地址到 MAC 地址的映射，此时主机 A 通过广播的方式发送 ARP 请求分组，主机 B 收到该请求后会发送 ARP 响应分组给主机 A 告知其 MAC 地址，随后主机 A 向其高速缓存中写入主机 B 的 IP 地址到 MAC 地址的映射。

![image-20250312214047240](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209719.png)

ARP协议作用在逐段链路或逐个网络使用，ARP没有安全验证机制，存在ARP欺骗（攻击）问题。

## 4、路由选择协议

![image-20250312214957247](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209720.png)

+ 自适应：动态路由选择，能较好地适应网络状态的变化
+ 分布式：路由之间交换路由信息
+ 分层次：将整个因特网划分为许多较小的自治系统AS「不同AS可以使用不同的路由选择协议」

![image-20250312215313697](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209721.png)

路由器从功能上可以划分为：路由选择和分组转发。

分组转发结构由三个部分组成：交换结构、一组输入端口和一组输出端口。

![image-20250312215442810](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209722.png)

### （1）路由信息协议RIP

+ RIP使用跳数作为度量来衡量到达网络的距离
	+ 路由器到直连网络的距离定义为1
	+ 路由器到非直连网络的距离定义为所经过的路由数加1
	+ 允许一条路径最多只能包含15个路由器，“距离”等于16时相当于不可达。因此，RIP只适用于小型互联网。
	+ ![image-20250313210626223](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209723.png)
+ RIP认为好的路由就是“距离短”的路由，也就是所通过路由数量少的路由。
+ 当到达同一目的网络有多条“距离相等”的路由时，可以进行等价负载均衡。
+ RIP包含以下三个要点：
	+ 和谁交换信息-->仅和相邻路由器交换信息
	+ 交换什么信息-->自己的路由器
	+ 何时交换信息-->周期性交换信息
+ 距离向量算法：
	+ 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
	+ 对修改后的 RIP 报文中的每一个项目，进行以下步骤：
	+ 若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
	+ 否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
	+ 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。

### （2）开放最短路径优先OSPF

开放最短路径优先OSPF，是为了克服RIP的缺点而开发出来的。

开放表示OSPF不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了Dijkstra提出的最短路径算法SPF。

OSPF具有以下特点：

+ 向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
+ 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
+ 只有当链路状态发生变化时，路由器才会发送信息。

所有路由器都具有全网的拓扑结构图，并且是一致的。相比于RIP，OSPF的更新过程收敛的很快「不限制网络规模，更新效率高」。

### （3）边界网关协议BGP

+ 不同系统之间的路由选择必须考虑相关策略「政治、经济、安全」
+ BGP只能说力求寻找一条能够到达目的网络且比较好的路由「不能兜圈子」，而并非要寻找一条最佳路由。
+ 每个AS必须配置一个“BGP发言人”，通过两个相邻BGP发言人之间建立TCP连接「端口号：179」来交换路由信息。

![image-20250315152133472](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209724.png)

## 5、IPv4数据报的首部格式

![image-20250315152922202](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209725.png)

+ 版本：占4比特，有4（IPv4）和6（IPv6）两个值，通信双方使用的IP协议的版本必须一致。
+ 首部长度：占4比特，该字段的取值以4字节为单位。最小十进制取值为5，表示IP数据报首部只有20字节固定部分；最大十进制取值为15，表示IP数据报首部包含20字节固定部分和最大40字节可变部分。
+ 区分服务：占8比特，一般情况不使用。
+ 总长度：占16比特，包括首部长度和数据部分长度。
+ 生存时间TTL：占8比特，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，路由器转发IP数据报时，将IP数据报首部中的该字段的值减1，若不为0就转发，否则就丢弃。
+ 协议：占8比特，指出携带的数据应该上交给哪个协议进行处理，常用的一些协议和相应的协议字段如下：
	+ ![image-20250315154903484](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209726.png)
+ 首部校验和：占16比特，用来检验首部在传输过程中是否出现差错。每经过一个路由器都要重新计算首部校验和，因为某些字段[生存时间、标志、片偏移...]的数值可能发生变化；由于IP层本身并不提供可靠传输的服务，并且计算首部校验和是一项耗时的操作，因此在IPv6中，路由器不再计算首部校验和，从而更快转发IP数据报。
+ 标识：占16比特，在数据报长度过长从而发生分片的情况下，想通数据报的不同分片具有相同的标识符。
+ 标志：占3比特，DF位：1表示不允许分片，0表示允许分片；MF位：1表示后面还有分片，0表示这是最后一个分片；保留位，必须为0；
+ 片偏移：占13比特，指出分片数据报的数据载荷部分偏移其在原数据报的位置有多少个单位，片偏移以8个字节位单位。
+ ![image-20250315163635693](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209727.png)

## 6、网际控制报文协议ICMP

ICMP 是为了更有效地转发 IP 数据报和提高交付成功的机会。它封装在 IP 数据报中，但是不属于高层协议。

![image-20250315164910813](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209728.png)

ICMP 报文分为差错报告报文和询问报文：

![image-20250315164946645](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209729.png)

### （1）Ping

Ping 是 ICMP 的一个重要应用，主要用来测试两台主机之间的连通性。Ping 的原理是通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

### （2）traceroute[<=30]

Traceroute 是 ICMP 的另一个应用，用来跟踪一个分组从源点到终点的路径。

Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。

+ 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
+ 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
+ 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
+ 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。

## 7、虚拟专用网VPN

由于IPv4地址的紧缺，一个机构能够申请到的IPv4地址数量往往远小于本机构所拥有的主机数量。因此，虚拟专用网中的各主机所分配的地址应该是本机构可自由分配的专用地址，而不是需要申请的、在因特网上使用的公有地址。

专用（私有）地址：

+ 10.0.0.0~10.255.255.255（10/8地址块）
+ 172.16.0.0~172.31.255.255（172.16/12地址块）
+ 192.168.0.0~192.168.255.255（192.168/16地址块）

![image-20250315202951850](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209730.png)

![image-20250315203002248](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209731.png)

## 8、网络地址转换NAT

专用网内部的主机使用本地 IP 地址又想和互联网上的主机通信时，可以使用 NAT 来将本地 IP 转换为全球 IP。

在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多只可以同时有 n 台主机接入互联网。为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把传输层的端口号也用上了，使得多个专用网内部的主机共用一个全球 IP 地址。使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。

![image-20250315203416413](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209732.png)

对于一些P2P网络应用，需要外网主机主动与内网主机进行通信，在通过NAT时会遇到问题（NAT路由器收到来自外网的IP数据报后，在NAPT转换表中找不到相应的记录），需要网络应用自己使用一些特殊的NAT穿越技术来解决问题。

另外，由于NAT对外网屏蔽了内网主机的网络地址，能为内网的主机提供一定的安全保护。

# 5.运输层

## 1、概述

网络层实现了主机到主机的通信，但是真正通信的实体是位于通信两端主机中的进程，如何为运行在不同主机上的应用进程提供直接的通信服务是运输层的任务，运输层协议又称为端到端协议。

运输层向高层用户屏蔽了下面网络核心的细节，使应用进程看见的就好像是在两个运输实体之间有一条端到端的逻辑通信信道。

![image-20250315210719010](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209733.png)

## 2、端口号

TCP/IP体系的运输层使用端口号来区分应用层的不同应用进程（统一的方法）：熟知端口号，0-1023；登记端口号，1024-49151；短暂端口号，49152-65535。[只具有本地意义，为了标识本计算机应用层中的各进程]

![image-20250315212151730](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209734.png)

## 3、UDP和TCP的对比

+ 用户数据报协议UDP（User Datagram Protocol）是无连接的，尽最大努力交付（也就是不可靠），不使用流量控制和拥塞控制，对应用层交付的报文直接打包，支持一对一，一对多，多对一，多对多交互通信，首部开销小，仅8字节。
+ 传输控制协议TCP（Transmission Control Protocol）是面向连接的，提供可靠交付，使用流量控制和拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条TCP连接只能有两个端点EP，只能是一对一通信，首部最小20字节，最大60字节。

## 4、UDP首部格式

![image-20250315213659522](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209735.png)

首部字段只有8字节，包块源端口，目的端口，长度，校验和。12字节的伪首部是为了计算校验和临时添加的。

## 5、TCP首部格式

![image-20250315214112588](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209736.png)

+ **端口**：占16比特，写入端口号，用来标识该TCP报文段的应用进程。
+ **序号**：占32比特，序号增加到最后一个后，下一个序号就又回到0。指出本TCP报文段数据载荷的第一个字节的序号。![image-20250315215301327](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209737.png)
+ **确认号**：占32比特，确认号增加到最后一个后，下一个确认号就又回到0。指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前收到的所有的数据的确认。若确认号等于n，则表明到序号n-1为止的所有数据都已正确接收，期望接收序号为n的数据。
+ **数据偏移**：占4比特，并以4字节为单位。用来指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远，实际上指TCP报文段的首部长度。（0101-1111）-->（20-60）
+ **确认标志位ACK**：当ACK=1时，确认字段才有效，否则无效。TCP规定，在连接建立后所有发送的TCP报文段都必须把ACK置1。
+ **同步标志位SYN**：在TCP连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。
+ **终止标志位FIN**：用来释放TCP连接。当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
+ **复位标志位RST**：用来复位TCP连接。当RST=1时，表明TCP连接出现了异常，必须释放连接，然后再重新建立连接。RST置1还用来拒绝一个非法的报文段或拒绝打开一个TCP连接。
+ **推送标志位PSH：**接收方的TCP收到该标志位为1的报文段会尽快上交应用进程，而不必等待接收缓存都填满后再向上交付。
+ **紧急标志位URG：**取值为1时紧急指针字段有效。否则无效。
+ **紧急指针：**占16比特，以字节为单位，用来指明紧急数据的长度。当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立刻封装到一个TCP报文段中运行发送，紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据。
+ **窗口**：占16比特，以字节为单位。指出发送本报文段的一方的接收窗口。窗口值作为接收方让发送方设置其发送窗口的依据。这是以接收方的接受能力来控制发送方的发送能力，称为流量控制。
+ **校验和**：占16比特，首部+数据载荷，要在TCP报文段的前面加上12字节的伪首部。
+ 选项（长度可变）：
	+ 最大报文段长度MSS选项：TCP报文段数据载荷部分的最大长度。
	+ 窗口扩大选项：为了扩大窗口（提高吞吐率）
	+ 时间戳选项：计算往返时间RTT；处理序号超范围的情况（防止序号绕回PAWS）
	+ 选择确认选项
+ **填充：**由于选项的长度可变，因此使用填充来确保报文段首部能被4整除。

## 6、TCP的流量控制

流量控制就是让发送方的发送速率不要太快，保证接收方来得及接收。

+ 利用滑动窗口机制可以很方便地在TCP连接上实现对发送方的流量控制。
	+ TCP接收方利用自己的接收窗口的大小来限制发送方发送窗口的大小。
	+ TCP发送方收到接收方的零窗口通知（不能发送数据）后，应启动持续计时器。持续计时器超时后，向接收方发送零窗口探测报文。

## 7、TCP的拥塞控制

在某段时间，若对网络中某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏，这种情况就叫做拥塞（带宽、交换节点中的缓存和处理机都是网络的资源）

若出现拥塞而不进行控制，整个网络的吞吐量将随输入负荷的增大而下降。

![image-20250316140604293](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209738.png)

TCP主要通过四个算法来进行拥塞控制：慢开始、拥塞避免、快重传、快恢复。

为了方便讨论，假定如下条件：

+ 数据是单方向传送，而另一个方向只传送确认。
+ 接收方总是有足够大的缓存空间，因而发送方发送窗口的大小由网络的拥塞程度来决定。
+ 以最大报文段MSS的个数为讨论问题的单位，而不是以字节为单位。

![image-20250316140730931](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209739.png)

### （1）慢开始和拥塞避免

+ 发送方维护一个叫做拥塞窗口cwnd的状态变量，其值取决于网络的拥塞程度，并且动态变化。
	+ 拥塞窗口cwnd的维护原则：只要网络没有出现拥塞，拥塞窗口就再增大一些；但主要网络出现拥塞，拥塞窗口就减少一些。
	+ 判断出现网络拥塞的依据：没有按时收到应到达的确认报文（即发生超时重传）
+ 发送方将拥塞窗口作为发送窗口，即swnd=cwnd
+ 维护一个慢开始门限ssthresh状态变量：
	+ 当cwnd<ssthresh时，使用慢开始算法
	+ 当cwnd>ssthresh时，停止使用慢开始算法而改用拥塞控制算法
	+ 当cwnd=ssthresh时，即可使用慢开始算法，也可使用拥塞控制算法
+ 使用拥塞控制算法时，每个轮次只将cwnd加1。如果重传计时器超时，则判断网络很可能出现了拥塞：
	+ 将ssthresh值更新为发生拥塞控制时cwnd值的一半
	+ 将cwnd值减小为1，并重新开始执行慢开始算法
+ 慢开始是指一开始向网络注入的报文段少，而不是指拥塞窗口cwnd增长速度慢（倍数增加）
+ 拥塞避免并非指完全能够避免拥塞，而是指在拥塞避免阶段将拥塞窗口控制为线性规律增长，使网络比较不容易出现拥塞。

有时个别报文段会在网络中丢失，但实际上网络并未发生拥塞，这将导致发送方超时重传，并认为网络发生了拥塞，发送发将拥塞窗口cwnd又设置为最小值1，并错误启动慢开始算法，因而降低了传输效率。采用快重传算法可以让发送方尽早知道发生了个别报文段的丢失。

### （2）快重传和快恢复

+ 所谓快重传，就是使发送方尽快进行重传，而不是等待超时重传计时器超时再重传。
	+ 要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认
	+ 即使收到了失序的报文段也要立即发出对已收到的报文段的重复确认
	+ 发送发一旦收到3个连续的重复确认，就将相应的报文段立即重传，而不是等待该报文段的超时重传计时器超时再重传。
	+ 对于个别丢失的报文段，发送发不会出现超时重传，也就不会误认为出现了拥塞。使用快重传可以使整个网络的吞吐量提高约20%。
+ 发送方一旦收到3个重复确认，就知道现在只是丢失了个别的报文段。于是不启动慢开始算法，而执行快恢复算法：
	+ 发送方将慢开始门限ssthresh值和拥塞窗口cwnd值调整为当前窗口的一半；开始执行拥塞避免算法
	+ 也有的快恢复实现是把快恢复开始时的拥塞窗口cwnd值再增大一些，即等于新的ssthresh+3
		+ 既然发送方收到3个重复确认，就表明有3个数据报文段已经离开了网络
		+ 这3个报文段不再消耗网络资源而是停留在接收方的接收缓存中
		+ 可见现在网络中不是堆积了报文段而是减少了3个报文段，因此可以适当把拥塞窗口扩大些。

![image-20250316145049691](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209740.png)

## 8、TCP超时重传时间

一个报文段从发送再到接收到确认所经过的时间称为往返时间 RTT，加权平均往返时间 RTTs 计算如下：

![img](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209741.gif)

其中，0 ≤ a ＜ 1，RTTs 随着 a 的增加更容易受到 RTT 的影响。

超时时间 RTO 应该略大于 RTTs，TCP 使用的超时时间计算如下：

![img](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209742.gif)

其中 RTTd 为偏差的加权平均值。

## 9、TCP的可靠传输

TCP基于以字节为单位的滑动窗口来实现可靠传输。

窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小。

发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且已确认的状态；接收窗口的滑动类似，接收窗口左部字节已经发送确认并交付主机，就向右滑动接收窗口。

接收窗口只会对窗口内最后一个按序到达的字节进行确认，例如接收窗口已经收到的字节为 {31, 34, 35}，其中 {31} 按序到达，而 {34, 35} 就不是，因此只对字节 31 进行确认。发送方得到一个字节的确认之后，就知道这个字节之前的所有字节都已经被接收。

![image-20250316151831383](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209743.png)

## 10、TCP的三次握手

![image-20250316153321185](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209744.png)

假设 A 为客户端，B 为服务器端。

+ 首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。
+ A 向 B 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。
+ B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。
+ A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。
+ B 收到 A 的确认后，连接建立。

**三次握手的原因**

第三次握手是为了防止失效的连接请求到达服务器，让服务器错误打开连接。

客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

![image-20250316153534592](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209745.png)

**注意：**

+ TCP的标准规定，SYN = 1的报文段不能携带数据，但要消耗掉一个序号。
+ TCP的标准规定，普通的确认报文段如果不携带数据，则不消耗序号。

## 11、TCP的四次挥手

![image-20250316154005029](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209746.png)

以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。

+ A 发送连接释放报文，FIN=1。
+ B 收到之后发出确认，此时 TCP 属于半关闭状态，B 能向 A 发送数据但是 A 不能向 B 发送数据。
+ 当 B 不再需要连接时，发送连接释放报文，FIN=1。
+ A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。
+ B 收到 A 的确认后释放连接。

**四次挥手的原因**

客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

**TIME_WAIT**

客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：

+ 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
+ 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

# 6.应用层

## 1、主机之间的通信方式

+ 客户-服务器（C/S）：客户是服务的请求方，服务器是服务的提供方。![image-20250316154635258](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209747.png)
+ 对等（P2P）：不区分客户和服务器。![image-20250316154655875](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209749.png)

## 2、动态主机配置协议DHCP

DHCP (Dynamic Host Configuration Protocol) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。

DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。

DHCP 工作过程如下：

1. 客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP（DHCP客户，68；DHCP服务器，67）中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。
2. DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

![image-20250316155313940](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209750.png)

## 3、域名系统DNS

DNS 是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。

域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

![image-20250316160011832](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209751.png)

DNS 可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 53。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。在两种情况下会使用 TCP 进行传输：

+ 如果返回的响应超过的 512 字节（UDP 最大只支持 512 字节的数据）。
+ 区域传送（区域传送是主域名服务器向辅助域名服务器传送变化的那部分数据）。

## 4.文件传送协议FTP

FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：

+ 控制连接：服务器打开端口号 21 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
+ 数据连接：用来传送一个文件数据。

根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：

+ 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0~1023 是熟知端口号。![image-20250316160616524](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209752.png)

+ 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。![image-20250316160639457](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209753.png)

主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

## 5、电子邮件协议

一个电子邮件系统由三部分组成：用户代理、邮件服务器以及邮件协议。

邮件协议包含发送协议和读取协议，发送协议常用 SMTP，读取协议常用 POP3 和 IMAP。

![image-20250316160955988](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209754.png)

### （1）SMTP

SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则。

![image-20250316161105414](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209755.png)

### （2）POP3

用户只能以下载并删除方式或者下载并保留方式从邮件服务器下载邮件到用户计算机，不允许用户在邮件服务器上管理自己的邮件。

### （3）IMNP

用户在自己的计算机上就可以操控邮件服务器中的邮箱（联机协议，POP：110；IMAP4:143）

## 6、常用端口

![image-20250316161912190](https://xiaokcoding-image.oss-cn-beijing.aliyuncs.com/20250329170209756.png)
